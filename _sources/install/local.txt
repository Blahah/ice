Deployment Guide
================

This guide will help you quickly set up an ICE installation
for production use.

Amazon Web Services (AWS)
-------------------------
The easiest way is to use AWS Elastic Beanstalk. Although the setup time is similar to the time for a custom server install, you get additional benefits including automatic security updates, database backups, and automatic monitoring, graphing and notification of server events. The following page will show you how to get started with it.

:doc:`aws`

Custom Server
-------------
Server setup takes a few steps

* installing an SSL certificate
* pointing Web server at the ICE war
* Set up the database
* Set some system properties
* Restart the Web server

Requirements
~~~~~~~~~~~~
You'll need the following

* A Debian (or Debian-like) server
* An SSL certificate. You can `purchase one here <https://www.namecheap.com/security/ssl-certificates/comodo.aspx>`__ or `follow these steps <http://stackoverflow.com/questions/10175812/how-to-create-a-self-signed-certificate-with-openssl>`__ to generate a self-signed certificate.

Software Installation
~~~~~~~~~~~~~~~~~~~~~
Install the following software

* `Apache Tomcat <http://tomcat.apache.org/download-70.cgi>`__
* `BLAST+ <http://blast.ncbi.nlm.nih.gov/Blast.cgi?PAGE_TYPE=BlastDocs&DOC_TYPE=Download>`__
* `PostgreSQL <http://www.postgresql.org/download/>`__
* `Java JDK 7 <http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html>`__
* `Maven <https://maven.apache.org/download.cgi>`__

using this command

::

  sudo apt-get install tomcat7 ncbi-blast+ default-jdk \
    maven postgresql 

WAR installation
~~~~~~~~~~~~~~~~
Download `the latest ICE war <https://github.com/JBEI/ice/releases>`__ from Github and make it the ROOT application on your tomcat installation. You may have to delete the existing ROOT application first.

::

  sudo wget https://github.com/JBEI/ice/releases/download/4.1.14/ice-4.1.14.war \
    --output-file /var/lib/tomcat7/webapps/ROOT.war

Database setup
~~~~~~~~~~~~~~
Create a new PostgreSQL database and create a database user that ICE can use to connect to the database.

::

  sudo -u postgres psql --command \
    "CREATE DATABASE registry; CREATE USER 'tomcat7' WITH PASSWORD 'tomcat7';"


Set System Properties
~~~~~~~~~~~~~~~~~~~~~
In order for ICE to connect to the database, you'll need to set some system properties that Tomcat will pass along when starting up. Create the file ``/usr/share/tomcat7/bin/setenv/sh`` and set the ``CATALINA_OPTS`` environment variable.

::

  sudo echo "export CATALINA_OPTS="$CATALINA_OPTS \
    -DRDS_HOSTNAME=localhost \
    -DRDS_PORT=5432 \
    -DRDS_DB_NAME=registry \
    -DRDS_username=tomcat7 \
    -DRDS_PASSWORD=tomcat7" > /usr/share/tomcat7/bin/setenv/sh


Install the SSL Certificate
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Import your certificate into a Tomcat keystore wherevere you like. We'll use ``/etc``
::

  sudo keytool -import -trustcacerts -alias server \
    -keystore /etc/tomcat7/.keystore -file <certificate> 

Now edit ``/etc/tomcat7/server.xml`` to configure SSL using the keystore by adding the following fragment

::
  
  <Connector
       protocol="org.apache.coyote.http11.Http11Protocol"
       port="8443" maxThreads="200"
       scheme="https" secure="true" SSLEnabled="true"
       keystoreFile=".keystore" keystorePass="changeit"
       clientAuth="false" sslProtocol="TLS"/>


View the Application
~~~~~~~~~~~~~~~~~~~~

Restart Tomcat

::

  sudo service restart tomcat7

And you should now be able to see ICE running at https://localhost:8443.